<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIME REPORT - Create Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #e9eff4 0%, #d1dbe6 100%);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 800px;
            margin: 2px auto;
            background: #ffffff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            position: relative;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .back-link {
            text-decoration: none;
            color: #1f81eb;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .back-link:hover {
            color: #1a6dc7;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 10px;
            border: 1px solid #c0c0c0;
        }

        th, td {
            border: 1px solid #c0c0c0;
            padding: 3px;
            text-align: center;
            font-size: 14px;
        }

        .header {
            text-align: center;
            font-size: 24px;
            font-weight: 700;
            padding: 10px 0;
            background: linear-gradient(to right, #e0e0e2, #f8fafa);
            color: #333;
        }

        .yellow {
            background: linear-gradient(to bottom, #f4b400);
            color: #333;
            font-weight: 700;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        select {
            width: calc(100% - 10px);
            padding: 10px;
            margin: 1px 0;
            border: 0.1px solid #b6b2b2;
            border-radius: 150px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input[type="number"] {
            width: calc(100% - 10px);
            padding: 10px;
            margin: 1px 0;
            border: 0.1px solid #b6b2b2;
            border-radius: 150px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        textarea {
            width: calc(100% - 10px);
            padding: 10px;
            margin: 1px 0;
            border: 1px solid #b6b2b2;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.2s;
            resize: vertical;
            min-height: 150px;
            font-family: 'Roboto', sans-serif;
        }

        input[list="berthList"],
        input[list="yardList"],
        input[list="whatWeUseList"],
        input[list="Equipment"],
        input[list="operator1"],
        input[list="operator2"] {
            width: calc(100% - 10px);
            padding: 10px;
            margin: 1px 0;
            border: 0.1px solid #b6b2b2;
            border-radius: 150px;
            box-sizing: border-box;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        /* Delete button styling */
        .delete-btn {
            background: linear-gradient(to bottom, #ff5252, #ff5252);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .delete-btn:hover {
            background: linear-gradient(to bottom, #ff5252, #ff0000);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .delete-btn:active {
            transform: translateY(0);
        }

        .add-line-btn {
            margin: 5px;
            padding: 10px 18px;
            background: linear-gradient(to bottom, #52aa67, #52a764);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .add-line-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .add-line-btn:active {
            transform: translateY(0);
        }

        .add-equipment-btn {
            background: linear-gradient(to bottom, #52aa67);
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .save-image-btn {
            background: linear-gradient(to bottom, #1f81eb, #1e7ee4) !important;
        }

        .save-pdf-btn {
            background: linear-gradient(to bottom, #cf3343, #c02d3b) !important;
        }

        .print-btn {
            background: linear-gradient(to bottom, #6c757d, #5a6268) !important;
        }

        .add-buttons-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .add-buttons-container .add-line-btn {
            margin-left: 10px;
        }

        .screenshot-guide {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            text-align: center;
            max-width: 500px;
            display: none;
            border: 1px solid #007bff;
        }

        .screenshot-guide h3 {
            margin-top: 0;
            color: #007bff;
            font-size: 22px;
            margin-bottom: 15px;
        }

        .screenshot-guide p {
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 16px;
            color: #333;
        }

        .close-guide {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: background 0.3s;
        }

        .close-guide:hover,
        .close-guide:focus {
            background: #0069d9;
        }

        .guide-icon {
            font-size: 48px;
            color: #28a745;
            margin-bottom: 15px;
        }

        @media print {
            body {
                background-color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 0;
                margin: 0;
            }

            .container {
                box-shadow: none;
                border-radius: 0;
                padding: 0;
                width: 100%;
                margin: 0;
            }
            .form-header {
                display: none;
            }

            button,
            .add-line-btn,
            .form-actions {
                display: none !important;
            }

            table,
            th,
            td {
                border-color: #000 !important;
            }

            th,
            td {
                padding: 8px;
            }
        }

        .screenshot-mode .form-actions,
        .screenshot-mode .add-member-btn,
        .screenshot-mode .add-line-btn {
            display: none !important;
        }

        /* Hide delete buttons in screenshot mode */
        .screenshot-mode .delete-btn,
        .screenshot-mode .equipment-delete-btn,
        .screenshot-mode .member-delete-btn {
            display: none !important;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="form-header">
            <a href="index.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                Back to Home
            </a>
        </div>
        <!-- Added ID to the form for JS selection -->
        <form id="reportForm">
            <table> <!--table 1-->
                <tr>
                    <td colspan="7" class="header">TIME REPORT</td>
                </tr>
            </table>

            <table> <!--table 2-->
                <tr class="yellow">
                    <th>MV</th>
                    <th>VOY</th>
                    <th>Date</th>
                    <th>Shift</th>
                </tr>
                <tr>
                    <td><input type="text" id="mv" name="mv" required></td>
                    <td><input type="text" id="voy" name="voy" required></td>
                    <td><input type="date" id="date" name="date" required></td>
                    <td>
                        <select id="shift" name="shift" required>
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                    </td>
                </tr>
            </table>

            <table> <!--table 3-->
                <tr class="yellow">
                    <th>Berth</th>
                    <th>Bollard</th>
                    <th>Yard No</th>
                </tr>
                <tr>
                    <td>
                        <input list="berthList" id="berth" name="berth">
                        <datalist id="berthList">
                            <option value="110">
                            <option value="120">
                            <option value="130">
                            <option value="140">
                            <option value="150">
                            <option value="160">
                            <option value="170">
                            <option value="180">
                            <option value="190">
                            <option value="FB-200">
                            <option value="FB-210">
                            <option value="FB-220">
                            <option value="ODC">
                        </datalist>
                    </td>
                    <td><input type="text" id="bollard" name="bollard"></td>
                    <td>
                        <input list="yardList" id="yardno" name="yardno">
                        <datalist id="yardList">
                            <option value="Admin Gate">
                            <option value="Gate IN">
                            <option value="Gate OUT">
                            <option value="Port Security">
                            <option value="Yard-DB">
                            <option value="Yard-BB">
                            <option value="Yard-RORO">
                            <option value="Yard-CT">
                            <option value="Yard-CFS">
                            <option value="Yard-Navy">
                            <option value="Washing Area">
                            <option value="Wood yard">
                            <option value="Warehouse">
                        </datalist>
                    </td>
                </tr>
            </table>

            <!--table 4-->
            <table class="compact-table">
                <tr class="yellow">
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>No</th>
                    <th>What We Use</th>
                    <th></th>
                </tr>
                <tbody id="timeTable">
                    <tr>
                        <td><input type="time" name="start"></td>
                        <td><input type="time" name="end"></td>
                        <td><input type="number" name="quantity" min="1" value="1"></td>
                        <td>
                            <input list="whatWeUseList" name="what_we_use">
                                <datalist id="whatWeUseList">
                                    <option value="Foreman">
                                    <option value="Tallyman">
                                    <option value="Docker">
                                    <option value="FL 3T">
                                    <option value="FL 5T">
                                    <option value="FL 11T">
                                    <option value="FL 16T">
                                    <option value="FL 25T">
                                    <option value="RS">
                                    <option value="TT">
                                    <option value="WL">
                                    <option value="Mooring">
                                    <option value="UnMooring">
                                    <option value="Gangway">
                                    <option value="Force Protection Wall">
                                    <option value="Fender">
                                    <option value="Browstand">
                                    <option value="Lighting Generator">
                                    <option value="Cement Block">
                                    <option value="Generator">
                                    <option value="SC">
                                    <option value="STS">
                                    <option value="RTG">
                                    <option value="Crane">
                                    <option value="HMC">
                                    <option value="ML">
                                    <option value="BC">
                                    <option value="VC">
                                    <option value="AR">
                                    <option value="Brrier">
                                    <option value="Fire Truck">
                                    <option value="Container">
                                </datalist>
                        </td>
                        <td><button type="button" class="delete-btn" onclick="deleteTimeRow(this)">Delete</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-line-btn" onclick="addTimeRow()">+ Add Line</button>

            <!--table 5-->
            <table>
                <tr class="yellow">
                    <th> What We Do</th>
                </tr>
                <tr>
                    <td>
                        <textarea id="activityTextarea" name="what_we_do" placeholder="Describe activities..."></textarea>
                    </td>
                </tr>
            </table>

            <!--table 6-->
            <table class="horizontal-team-table">
                <thead>
                    <tr>
                        <th>FOREMAN</th>
                        <th>TALLYMAN</th>
                        <th>DOCKER</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <div class="team-input-group" id="foremanInputs">
                                <div>
                                    <input list="foremanList" name="foreman" placeholder="ID">
                                    <button type="button" class="member-delete-btn" onclick="removeTeamMember(this)">Ã—</button>
                                </div>
                                <button type="button" class="add-member-btn" onclick="addTeamMember('foreman')">+</button>
                            </div>
                            <datalist id="foremanList">
                                <option value="69">
                                <option value="78">
                                <option value="110">
                                <option value="275">
                                <option value="AS-0001">
                                <option value="AS-0002">
                                <option value="AS-0003">
                                <option value="AS-0004">
                                <option value="AS-0005">
                                <option value="AS-0006">
                                <option value="AS-0007">
                                <option value="AS-0008">
                            </datalist>
                        </td>
                        <td>
                            <div class="team-input-group" id="tallymanInputs">
                                <div>
                                    <input list="tallymanList" name="tallyman" placeholder="ID">
                                    <button type="button" class="member-delete-btn" onclick="removeTeamMember(this)">Ã—</button>
                                </div>
                                <button type="button" class="add-member-btn" onclick="addTeamMember('tallyman')">+</button>
                            </div>
                            <datalist id="tallymanList">
                                <option value="178">
                                <option value="241">
                                <option value="AS-0009">
                                <option value="AS-0010">
                                <option value="AS-0011">
                                <option value="AS-0012">
                                <option value="AS-0013">
                                <option value="AS-0014">
                                <option value="AS-0015">
                                <option value="AS-0016">
                                <option value="AS-0017">
                                <option value="AS-0018">
                                <option value="AS-0019">
                                <option value="AS-0020">
                            </datalist>
                        </td>
                        <td>
                            <div class="team-input-group" id="dockerInputs">
                                <div>
                                    <input list="dockerList" name="docker" placeholder="ID">
                                    <button type="button" class="member-delete-btn" onclick="removeTeamMember(this)">Ã—</button>
                                </div>
                                <div>
                                    <input list="dockerList" name="docker" placeholder="ID">
                                    <button type="button" class="member-delete-btn" onclick="removeTeamMember(this)">Ã—</button>
                                </div>
                                <button type="button" class="add-member-btn" onclick="addTeamMember('docker')">+</button>
                            </div>
                            <datalist id="dockerList">
                                <option value="AS-0064">
                                <option value="AS-0065">
                                <option value="AS-0066">
                                <option value="AS-0067">
                                <option value="AS-0068">
                                <option value="AS-0069">
                                <option value="AS-0070">
                                <option value="AS-0071">
                                <option value="AS-0072">
                                <option value="AS-0073">
                                <option value="AS-0074">
                                <option value="AS-0075">
                                <option value="AS-0076">
                                <option value="AS-0077">
                                <option value="AS-0078">
                                <option value="AS-0079">
                                <option value="AS-0080">
                                <option value="AS-0081">
                                <option value="static: #f8f9fa;
            }
        </table>

            <div class="equipment-section">
                <table id="equipmentTable" class="equipment-table">
                    <thead>
                        <tr class="yellow">
                            <th>Equipment</th>
                            <th>Operator 1</th>
                            <th>Start</th>
                            <th>End</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <input list="Equipment" name="Equipment">
                                    <datalist id="Equipment">
                                        <option value="FL 3T">
                                        <option value="FL 5T">
                                        <option value="FL 11T">
                                        <option value="FL 16T">
                                        <option value="FL 25T">
                                        <option value="RS">
                                        <option value="TT">
                                        <option value="WL">
                                        <option value="SC">
                                        <option value="STS">
                                        <option value="RTG">
                                        <option value="Crane">
                                        <option value="HMC">
                                        <option value="ML">
                                        <option value="BC">
                                        <option value="VC">
                                    </datalist>
                            </td>
                            <td>
                                <input list="operator1" name="operator1">
                                    <datalist id="operator1">
                                        <option value="AS-0035">
                                        <option value="AS-0036">
                                        <option value="AS-0037">
                                        <option value="AS-0038">
                                        <option value="AS-0039">
                                        <option value="AS-0040">
                                        <option value="AS-0041">
                                        <option value="AS-0042">
                                        <option value="AS-0043">
                                        <option value="AS-0044">
                                        <option value="AS-0045">
                                        <option value="AS-0046">
                                        <option value="AS-0047">
                                        <option value="AS-0048">
                                        <option value="AS-0049">
                                        <option value="AS-0050">
                                        <option value="AS-0051">
                                        <option value="AS-0052">
                                        <option value="AS-0053">
                                        <option value="AS-0054">
                                        <option value="AS-0055">
                                        <option value="AS-0056">
                                        <option value="AS-0057">
                                        <option value="AS-0058">
                                        <option value="AS-0059">
                                        <option value="AS-0060">
                                        <option value="AS-0061">
                                        <option value="AS-0062">
                                        <option value="AS-0063">
                                        <option value="AS-0064">
                                        <option value="AS-0065">
                                        <option value="AS-0066">
                                        <option value="AS-0067">
                                        <option value="AS-0068">
                                        <option value="AS-0069">
                                        <option value="AS-0070">
                                        <option value="AS-0071">
                                        <option value="AS-0072">
                                        <option value="AS-0073">
                                        <option value="AS-0074">
                                        <option value="AS-0075">
                                        <option value="AS-0076">
                                        <option value="AS-0077">
                                        <option value=" parameters: 'static: #f8f9fa;
            }
        </table>
                <button type="button" class="add-line-btn add-equipment-btn" onclick="addEquipmentRow()">+ Add Line</button>
            </div>

            <div class="form-actions">
                <button type="submit" class="add-line-btn" id="saveReportBtn">Save Report</button>
                <button type="button" class="add-line-btn save-image-btn" id="saveImageBtn">Save as Image</button>
                <button type="button" class="add-line-btn save-pdf-btn" id="savePdfBtn">Save as PDF</button>
            </div>
        </form>
    </div>

    <div id="screenshotGuide" class="screenshot-guide">
        <div class="guide-icon">ðŸ“·</div>
        <h3>Screenshot Guide</h3>
        <p>Your report will be captured as an image. Make sure all information is entered correctly before saving.</p>
        <button class="close-guide" onclick="document.getElementById('screenshotGuide').style.display='none'">Got it!</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('reportForm');
            const saveBtn = document.getElementById('saveReportBtn');
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('editId');

            if (editId) {
                // If editing, load the report data into the form
                loadReportForEditing(editId);
                saveBtn.textContent = 'Update Report';
            }

            form.addEventListener('submit', function(event) {
                event.preventDefault(); // Stop normal form submission
                console.log("Form submission triggered."); // DEBUG: Log 1
                
                const reportData = collectFormData();
                console.log("Collected form data:", reportData); // DEBUG: Log 2
                
                if (!reportData) {
                    console.error("Form data collection failed. Aborting save."); // DEBUG: Log 3
                    alert("Error: Could not save the report. Please check all required fields and try again.");
                    return; // Stop the process
                }
                
                try {
                    let reports = JSON.parse(localStorage.getItem('timeReports')) || [];
                    console.log("Existing reports from storage:", reports); // DEBUG: Log 4
                    
                    if (editId) {
                        // Update existing report
                        const index = reports.findIndex(r => r.id === editId);
                        if (index !== -1) {
                            reports[index] = { ...reportData, id: editId };
                            console.log("Updating report at index:", index, reports[index]); // DEBUG: Log 5
                            alert('Report updated successfully!');
                        } else {
                            console.error("Report to update not found with ID:", editId); // DEBUG: Log 6
                            alert('Error: Could not find the report to update.');
                        }
                    } else {
                        // Save new report
                        reportData.id = 'report_' + Date.now(); // Create a unique ID
                        reports.push(reportData);
                        console.log("Adding new report. Total reports now:", reports.length); // DEBUG: Log 7
                        alert('Report saved successfully!');
                    }
                    
                    localStorage.setItem('timeReports', JSON.stringify(reports));
                    console.log("Reports saved to localStorage. Total:", reports.length); // DEBUG: Log 8
                    
                    // Redirect to search page after saving
                    window.location.href = 'search_reports.html';
                } catch (e) {
                    console.error("Failed to save to localStorage:", e); // DEBUG: Log 9
                    alert("A critical error occurred while saving the report. Your browser may be blocking storage. Please check your browser settings for 'Local Storage' and try again.");
                }
            });
        });

        // Function to load a report for editing
        function loadReportForEditing(reportId) {
            const reports = JSON.parse(localStorage.getItem('timeReports')) || [];
            const report = reports.find(r => r.id === reportId);
            
            if (!report) {
                alert('Report not found!');
                window.location.href = 'search_reports.html';
                return;
            }

            console.log("Loading report for editing:", report); // DEBUG: Log loading report data
            // Populate main fields
            document.getElementById('mv').value = report.mv || '';
            document.getElementById('voy').value = report.voy || '';
            document.getElementById('date').value = report.date || '';
            document.getElementById('shift').value = report.shift || '';
            document.getElementById('berth').value = report.berth || '';
            document.getElementById('bollard').value = report.bollard || '';
            document.getElementById('yardno').value = report.yardno || '';
            document.getElementById('activityTextarea').value = report.what_we_do || '';
            
            // Populate dynamic tables
            populateTimeTable(report.timeRecords || []);
            populateTeamMembers('foreman', report.team ? report.team.foreman || [] : []);
            populateTeamMembers('tallyman', report.team ? report.team.tallyman || [] : []);
            populateTeamMembers('docker', report.team ? report.team.docker || [] : []);
            populateEquipmentTable(report.equipmentRecords || []);
        }

        // Function to populate time table
        function populateTimeTable(records) {
            const tableBody = document.getElementById('timeTable');
            tableBody.innerHTML = ''; // Clear existing rows

            if (records.length === 0) {
                // Add one empty row if no data
                addTimeRow();
            } else {
                records.forEach(record => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td><input type="time" name="start" value="${record.start || ''}"></td>
                        <td><input type="time" name="end" value="${record.end || ''}"></td>
                        <td><input type="number" name="quantity" min="1" value="${record.quantity || 1}"></td>
                        <td>
                            <input list="whatWeUseList" name="what_we_use" value="${record.what_we_use || ''}">
                                <datalist id="whatWeUseList">
                                    <option value="Foreman">
                                    <option value="Tallyman">
                                    <option value="Docker">
                                    <option value="FL 3T">
                                    <option value="FL 5T">
                                    <option value="FL 11T">
                                    <option value="FL 16T">
                                    <option value="FL 25T">
                                    <option value="RS">
                                    <option value="TT">
                                    <option value="WL">
                                    <option value="Mooring">
                                    <option value="UnMooring">
                                    <option value="Gangway">
                                    <option value="Force Protection Wall">
                                    <option value="Fender">
                                    <option value="Browstand">
                                    <option value="Lighting Generator">
                                    <option value="Cement Block">
                                    <option value="Generator">
                                    <option value="SC">
                                    <option value="STS">
                                    <option value="RTG">
                                    <option value="Crane">
                                    <option value="HMC">
                                    <option value="ML">
                                    <option value="BC">
                                    <option value="VC">
                                    <option value="AR">
                                    <option value="Brrier">
                                    <option value="Fire Truck">
                                    <option value="Container">
                                </datalist>
                        </td>
                        <td><button type="button" class="delete-btn" onclick="deleteTimeRow(this)">Delete</button></td>
                    </tr>
                });
            }
        }

        // Function to populate team members
        function populateTeamMembers(type, members) {
            const container = document.getElementById(`${type}Inputs`);
            const addButton = container.lastElementChild; // The '+' button
            
            // Clear all existing member divs
            container.querySelectorAll('div').forEach(div => div.remove());
            
            if (members.length === 0) {
                // Add one empty input if no data
                const memberDiv = document.createElement("div");
                memberDiv.innerHTML = `<input list="${type}List" name="${type}" placeholder="ID"><button type="button" class="member-delete-btn" onclick="removeTeamMember(this)">Ã—</button>`;
                container.insertBefore(memberDiv, addButton);
            } else {
                members.forEach(member => {
                    const memberDiv = document.createElement("div");
                    memberDiv.innerHTML = `<input list="${type}List" name="${type}" value="${member}"><button type="button" class="member-delete-btn" onclick="removeTeamMember(this)">Ã—</button>`;
                    container.insertBefore(memberDiv, addButton);
                });
            }
        }

        // Function to populate equipment table
        function populateEquipmentTable(records) {
            const tableBody = document.getElementById("equipmentTable").getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Clear existing rows

            if (records.length === 0) {
                // Add one empty row if no data
                addEquipmentRow();
            } else {
                records.forEach(record => {
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>
                            <input list="Equipment" name="Equipment" value="${record.Equipment || ''}">
                                <datalist id="Equipment">
                                    <option value="FL 3T">
                                    <option value="FL 5T">
                                    <option value="FL 11T">
                                    <option value="FL 16T">
                                    <option value="FL 25T">
                                    <option value="RS">
                                    <option value="TT">
                                    <option value="WL">
                                    <option value="SC">
                                    <option value="STS">
                                    <option value="RTG">
                                    <option value="Crane">
                                    <option value="HMC">
                                    <option value="ML">
                                    <option value="BC">
                                    <option value="VC">
                                    <option value="AR">
                                    <option value="Brrier">
                                    <option value="Fire Truck">
                                    <option value="Container">
                                </datalist>
                        </td>
                        <td>
                            <input list="operator1" name="operator1" value="${record.operator1 || ''}">
                                <datalist id="operator1">
                                    <option value="AS-0035">
                                    <option value="AS-0036">
                                    <option value="AS-0037">
                                    <option value="AS-0038">
                                    <option value="AS-0039">
                                    <option value="AS-0040">
                                    <option value="AS-0041">
                                    <option value="AS-0042">
                                    <option value="AS-0043">
                                    <option value="AS-0044">
                                    <option value="AS-0045">
                                    <option value="AS-0046">
                                    <option value="AS-0047">
                                    <option value="AS-0048">
                                    <option value="AS-0049">
                                    <option value="AS-0050">
                                    <option value="AS-0051">
                                    <option value="AS-0052">
                                    <option value="AS-0053">
                                    <option value="AS-0054">
                                    <option value="AS-0055">
                                    <option value="AS-0056">
                                    <option value="AS-0057">
                                    <option value="AS-0058">
                                    <option value="AS-0059">
                                    <option value="parameters: 'static: #f8f9fa;
            }
                        <td>
                            <button type="button" class="equipment-delete-btn" onclick="deleteEquipmentRow(this)">Delete</button>
                        </td>
                    </tr>
                });
            }
        }

        // Function to collect all form data
        function collectFormData() {
            console.log("Starting form data collection..."); // DEBUG: Log start
            // Basic validation
            const mv = document.getElementById('mv').value;
            const voy = document.getElementById('voy').value;
            
            if (!mv || !voy) {
                console.error("Validation failed: MV or VOY is missing.");
                alert('Validation Error: Vessel (MV) and Voyage (VOY) are required fields.');
                return null;
            }
            
            const team = {
                foreman: getTeamMemberValues('foremanInputs'),
                tallyman: getTeamMemberValues('tallymanInputs'),
                docker: getTeamMemberValues('dockerInputs')
            };
            
            const timeRecords = [];
            const timeRows = document.querySelectorAll('#timeTable tr');
            timeRows.forEach(row => {
                timeRecords.push({
                    start: row.querySelector('input[name="start"]').value,
                    end: row.querySelector('input[name="end"]').value,
                    quantity: row.querySelector('input[name="quantity"]').value,
                    what_we_use: row.querySelector('input[name="what_we_use"]').value
                });
            });
            console.log("Collected time records:", timeRecords); // DEBUG: Log team data
            
            const equipmentRecords = [];
            const equipmentRows = document.querySelectorAll('#equipmentTable tbody tr');
            equipmentRows.forEach(row => {
                equipmentRecords.push({
                    Equipment: row.querySelector('input[name="Equipment"]').value,
                    operator1: row.querySelector('input[name="operator1"]').value,
                    start1: row.querySelector('input[name="start1"]').value,
                    end1: row.querySelector('input[name="end1"]').value
                });
            });
            console.log("Collected equipment records:", equipmentRecords); // DEBUG: Log equipment data
            
            const reportData = {
                mv: mv,
                voy: voy,
                date: document.getElementById('date').value,
                shift: document.getElementById('shift').value,
                berth: document.getElementById('berth').value,
                bollard: document.getElementById('bollard').value,
                yardno: document.getElementById('yardno').value,
                what_we_do: document.getElementById('activityTextarea').value,
                team: team,
                timeRecords: timeRecords,
                // Note: For simplicity, we are not handling equipmentRecords here.
                // In a real app, these would need more complex handling.
                equipmentRecords: equipmentRecords
            };
            
            console.log("Final collected report data:", reportData); // DEBUG: Log final data
            return reportData;
        }

        function getTeamMemberValues(containerId) {
            const inputs = document.querySelectorAll(`#${containerId} input[name]`);
            return Array.from(inputs).map(input => input.value).filter(val => val !== '');
        }
    </script>
</body>
</html>